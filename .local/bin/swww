#!/usr/bin/env bash

if [[ "$DEBUG" -eq 1 ]]; then
    set -x
fi

BASE_URL="https://wallhaven.cc/search?q=<keyword>&categories=110&purity=000&atleast=1920x1080&ratios=16x9%2C16x10&sorting=random&order=desc&ai_art_filter=1"
DISPLAYS=(DP-1 DP-2 HDMI-A-1)
RESOLUTIONS=("2560x1440+0+1440" "2560x1440+0+0" "1080x1920+2560+680")
WALLPAPERS_DIR="${XDG_PICTURES_DIR}/wallpapers"

KEYWORDS=("nier")

URLS=()
for KEYWORD in "${KEYWORDS[@]}"; do
    URLS+=("${BASE_URL//<keyword>/${KEYWORD}}")
done
URLS=($(shuf -e "${URLS[@]}"))

URL="${URLS[0]}"

CONTENT=$(curl -s "${URL}")
CONTENT=($(echo ${CONTENT} | xidel -e '//a/@href[contains(., "/w/")]'))
CONTENT=($(shuf -e "${CONTENT[@]}"))

CONTENT=$(curl -s "${CONTENT[0]}")
CONTENT=($(echo ${CONTENT} | xidel -e '//img/@src[contains(., "/full/")]'))

WALLPAPER="${WALLPAPERS_DIR}/downloaded/$(echo "${CONTENT[0]}" | cut -f6 -d'/')"

[[ ! -f "${WALLPAPER}" ]] && curl "${CONTENT[0]}" -o "${WALLPAPER}" >/dev/null 2>&1

FILE_DIR=$(dirname "${WALLPAPER}")
FILE_NAME=$(basename "${WALLPAPER}")
if [ "${FILE_NAME##*.}" != "png" ]; then
    CONVERTED_WALLPAPER="${FILE_DIR}/${FILE_NAME%.*}.png"
    convert "${WALLPAPER}" "${CONVERTED_WALLPAPER}"
    rm "${WALLPAPER}"
    WALLPAPER="${CONVERTED_WALLPAPER}"
    FILE_NAME=$(basename "${WALLPAPER}")
fi

WALLPAPER_RESOLUTION=$(identify "${WALLPAPER}" | awk '{print $3}')
WALLPAPER_WIDTH=$(echo "${WALLPAPER_RESOLUTION}" | cut -f1 -d'x')
WALLPAPER_HEIGHT=$(echo "${WALLPAPER_RESOLUTION}" | cut -f2 -d'x')

if [[ "${WALLPAPER_WIDTH}" -lt 3840 ]] || [[ "${WALLPAPER_HEIGHT}" -lt 2880 ]]; then
    convert "${WALLPAPER}" -alpha on -virtual-pixel transparent -filter Triangle +distort Affine "0,0 0,0 %w,0 3840,0 0,%h 0,2880" -alpha off -filter Gaussian "${WALLPAPER}" >/dev/null 2>&1
fi

WALLPAPERS=()
for DISPLAY in "${DISPLAYS[@]}"; do
    WALLPAPERS+=("${WALLPAPERS_DIR}/${FILE_NAME%.*}_${DISPLAY}.png")
done

for i in "${!WALLPAPERS[@]}"; do
    if [ ! -f "${WALLPAPERS[i]}" ]; then
        convert -crop "${RESOLUTIONS[i]}" "${WALLPAPER}" "${WALLPAPERS[i]}"
    fi
done

notify-send "Changing wallpaper to ${WALLPAPER}"

if [[ "${XDG_CURRENT_DESKTOP}" == "sway" ]] || [[ "${XDG_CURRENT_DESKTOP}" == "Hyprland" ]]; then
    if command -v "swww" >/dev/null 2>&1; then
        for i in "${!DISPLAYS[@]}"; do
            /usr/bin/swww img -o "${DISPLAYS[i]}" "${WALLPAPERS[i]}"
        done
    fi
else
    if command -v "feh" >/dev/null 2>&1; then
        feh --bg-fill "${WALLPAPER}" 2>/dev/null
    elif command -v "nitrogen" >/dev/null 2>&1; then
        nitrogen --set-zoom-fill --save "${WALLPAPER}" 2>/dev/null
    fi
fi
